<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.0.0">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2019-09-30T20:34:11+05:30</updated><id>http://localhost:4000/feed.xml</id><title type="html">Anoop’s page</title><subtitle>&quot;For a bunch of hairless apes, we've actually managed to invent some pretty incredible things.&quot; - Ernest Cline, Ready Player One
</subtitle><author><name>Anoop Elias</name></author><entry><title type="html">Network Address Translation</title><link href="http://localhost:4000/tech/2019/09/30/network-address-translation.html" rel="alternate" type="text/html" title="Network Address Translation" /><published>2019-09-30T00:00:00+05:30</published><updated>2019-09-30T00:00:00+05:30</updated><id>http://localhost:4000/tech/2019/09/30/network-address-translation</id><content type="html" xml:base="http://localhost:4000/tech/2019/09/30/network-address-translation.html">&lt;p&gt;I had a &lt;em&gt;Raspberry Pi 3&lt;/em&gt; lying around, and I had a great idea. Let’s host a &lt;a href=&quot;https://www.eff.org/torchallenge/what-is-tor.html&quot;&gt;Tor relay&lt;/a&gt;! This is the story of that failed mission. Do you copy?&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;So last day I was watching this movie, G R A V I T Y, again. One hell of a movie isn’t it? If this one doesn’t make you a fan of Sandra Bullock, then I don’t know what does! Anyway,&lt;/p&gt;

&lt;p&gt;To host a Tor relay, you need two things,&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;A fairly good internet connection,&lt;/li&gt;
  &lt;li&gt;A computer that can be online almost all the time,&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;or so I thought. But as you might have guessed, the devil is in the details! We will get there in due course.&lt;/p&gt;

&lt;hr /&gt;
&lt;h3 id=&quot;pi-setup&quot;&gt;Pi Setup&lt;/h3&gt;

&lt;p&gt;The Pi already had an SD card. I had a wireless keyboard, mouse, and a monitor with HDMI. The typical micro USB phone chargers are not powerful enough for a Pi 3. Thankfully I had this figured already and had ordered one.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/Qw9P7BW.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Let’s boot to the beautiful Raspbian background.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://imgur.com/9dNgIwY.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Next some basic cleanup on Raspbian,&lt;/p&gt;

&lt;p&gt;Set a new password:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pi@raspberrypi:~ $ sudo passwd pi
Enter new UNIX password:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Start SSH:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pi@raspberrypi:~ $ sudo systemctl enable ssh
pi@raspberrypi:~ $ sudo systemctl start ssh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The easiest way to find the IP of your device without even touching it is to go to the DHCP Client List of your router. Finding the IP is like this is very useful once you have the Pi connected to network sitting in some corner without an attached keyboard or monitor. Please note, you are looking for the ‘&lt;em&gt;Private&lt;/em&gt; IP’ of the Pi. More on this later.&lt;/p&gt;

&lt;p&gt;Open your browser on the laptop and go to &lt;a href=&quot;http://192.168.2.1/&quot;&gt;http://192.168.2.1/&lt;/a&gt;. Well, I am on Belkin. You gotta figure out &lt;a href=&quot;https://www.techspot.com/guides/287-default-router-ip-addresses/&quot;&gt;whats yours&lt;/a&gt;. For most routers, DHCP Client List will be there in the menu once you login.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/7fuhQmt.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;(I don’t know, maybe you could get the ‘Private IP’ of our Pi to be static, but that’s for another day, not in our MVP)&lt;/p&gt;

&lt;p&gt;There you go, now you can shell into the Pi from your own laptop,&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ ssh pi@192.168.2.12
pi@192.168.2.12's password:
Linux raspberrypi 4.19.66-v7+ #1253 SMP Thu Aug 15 11:49:46 BST 2019 armv7l

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Sun Sep 29 22:05:06 2019 from 192.168.2.40
pi@raspberrypi:~ $
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We’re just getting warmed up!&lt;/p&gt;

&lt;hr /&gt;
&lt;h3 id=&quot;remote-pi&quot;&gt;Remote Pi&lt;/h3&gt;

&lt;p&gt;Now this is a computer that needs to be connected by wire to the router sitting on top of my fridge. Its a small board, it can sit close to its home. But, I can’t get a monitor next to it. Solution: &lt;em&gt;VNC&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;For those of you who are not so amused, VNC is Virtual Network Computing, its a universal remote desktop mechanism that can work across Windows, macOS, and Linux. Let’s get the server running.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pi@raspberrypi:~ $ sudo apt-get install tightvncserver
pi@raspberrypi:~ $ tightvncserver
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now that we have our VNC server running fine, let’s try connecting from a client.&lt;/p&gt;

&lt;p&gt;On the laptop, if you may,&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ sudo apt-get install vncviewer
$ vncviewer
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On the prompt, enter the enter the private IP of Pi &lt;code class=&quot;highlighter-rouge&quot;&gt;192.168.2.12&lt;/code&gt;. And!&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ vncviewer
vncviewer: ConnectToTcpAddr: connect: Connection refused
Unable to connect to VNC server
$
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Hmm.. ! Actually, this took some time to figure out.&lt;/p&gt;

&lt;p&gt;Back in Pi, when we made sure the vncserver is running,&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pi@raspberrypi:~ $ ps aux | grep vnc
pi         754  0.1  1.8  56068 17148 ?        S    12:18   0:47 Xtightvnc :1 -desktop X -auth /home/pi/.Xauthority -geometry 1024x768 -depth 24 -rfbwait 120000 -rfbauth /home/pi/.vnc/passwd -rfbport 5901 -fp /usr/share/fonts/X11/misc/,/usr/share/fonts/X11/Type1/,/usr/share/fonts/X11/75dpi/,/usr/share/fonts/X11/100dpi/ -co /etc/X11/rgb
pi@raspberrypi:~ $
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Read that one real close. Xtightvnc is running on port 5901, not on its default 5900. For whatever reason.&lt;/p&gt;

&lt;p&gt;Okay then try &lt;code class=&quot;highlighter-rouge&quot;&gt;vncviewer&lt;/code&gt; again, but this time, the host is &lt;code class=&quot;highlighter-rouge&quot;&gt;192.168.2.12:5901&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/YKkhp8E.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Voila! Pi goes all the way to the top of the fridge.. :joy: Let’s get on with the Tor part now.&lt;/p&gt;

&lt;hr /&gt;
&lt;h3 id=&quot;network-address-translation&quot;&gt;Network Address Translation&lt;/h3&gt;

&lt;p&gt;&lt;em&gt;For Pi to be a Tor relay, it needs to be accessible from public network.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;When you are connected to the Internet, it only means that your PC can access the computers in the Internet. It doesn’t mean that those computers (or people) can access your PC. There will be an umpteen number of firewalls to prevent that to happen. On top of that, since the Internet is &lt;a href=&quot;https://en.wikipedia.org/wiki/IPv4_address_exhaustion&quot;&gt;running out of IPV4 addresses&lt;/a&gt;, the router puts up a concept called ‘NAT’.&lt;/p&gt;

&lt;p&gt;Yes, this is where we talk about ‘Private IP’ and ‘Public IP’. Hopefully the concept will be clear with the picture below,&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/mRFpBr3.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;When the ‘Private IP: F’ accesss lets say ‘Public IP: B’, from B’s point of view the request is coming from your router’s ‘Public IP: D’ *. Only your router gets a public IP, while your PCs, phones, smart TVs, all those will get only a ‘Private IP’!&lt;/p&gt;

&lt;p&gt;Now to the million dollar question : If ‘Public IP: B’ wants to access ‘Private IP: F’, how is that possible? ‘B’ is not even aware of the existance of ‘F’!&lt;/p&gt;

&lt;p&gt;That magic, my friends, is called ‘Network Address Translation’ a.k.a. ‘NAT’. The trick is simple. You use both IP and port for mapping. Eventhough we are running short of IPs, we have no shortage of ports. Each IP can handle over 65000+ ports.&lt;/p&gt;

&lt;p&gt;Let’s look at the ‘Virtual Servers’ table I have put up on my Belkin configuration,&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/bjC9wno.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Here we are saying that if an incoming request on the router comes on port 22 (SSH) or port 5901 (VNC), it needs to be forwarded to the Pi (&lt;code class=&quot;highlighter-rouge&quot;&gt;192.168.2.12&lt;/code&gt;). On the other hand, if it comes on port 80, forward it to laptop (&lt;code class=&quot;highlighter-rouge&quot;&gt;192.168.2.40&lt;/code&gt;).&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Now to the current problem:&lt;/strong&gt; &lt;em&gt;Even after adding Virtual Servers, SSH on my public IP fails…&lt;/em&gt; :worried:.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ ssh pi@106.51.241.13
ssh: connect to host 106.51.241.13 port 22: Connection timed out
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I am guessing that the TCP handshake is not reaching the router, this could be a firewall with my ISP, they could be blocking these incoming connections before even it reaches the router. This is a home network after all. I have raised a ticket with them, and is waiting for a reply as we speak.&lt;/p&gt;

&lt;hr /&gt;
&lt;h3 id=&quot;upnp&quot;&gt;UPnP&lt;/h3&gt;

&lt;p&gt;Meanwhile, we won’t give up without putting up a fight!&lt;/p&gt;

&lt;p&gt;How can we prove that the TCP handshake is not reaching the router? Router do not have an OS in it, its some kind of firmware that is running there. Can we see what is going on inside? Keep looking!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/njfmNKP.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Hmm… Interesting! Whenever the BitTorrent client starts on a PC, a set of NAT rules gets added automatically on the router. How come?&lt;/p&gt;

&lt;p&gt;Did a bit more digging. It seems, there is a protocol called &lt;a href=&quot;https://en.wikipedia.org/wiki/Universal_Plug_and_Play&quot;&gt;Universal Plug n Play (UPnP)&lt;/a&gt; that most of the network devices support. With that you can programmatically add a NAT rule into the router. While we are at it, let’s try that too.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;http://miniupnp.free.fr/&quot;&gt;MiniUPnP&lt;/a&gt; project provides tools to do this from command line,&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pi@raspberrypi:~ $ sudo apt-get install miniupnpc
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And,&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pi@raspberrypi:~ $ upnpc -l
upnpc : miniupnpc library test client. (c) 2005-2014 Thomas Bernard
Go to http://miniupnp.free.fr/ or http://miniupnp.tuxfamily.org/
for more information.
List of UPNP devices found on the network :
 desc: http://192.168.2.1:35108/rootDesc.xml
 st: urn:schemas-upnp-org:device:InternetGatewayDevice:1

Found valid IGD : http://192.168.2.1:35108/ctl/IPConn
Local LAN ip address : 192.168.2.12
Connection Type : IP_Routed
Status : Connected, uptime=27340s, LastConnectionError : ERROR_NONE
  Time started : Sun Sep 29 19:34:14 2019
MaxBitRateDown : 4200000 bps (4.2 Mbps)   MaxBitRateUp 4200000 bps (4.2 Mbps)
ExternalIPAddress = 10.242.204.104
 i protocol exPort-&amp;gt;inAddr:inPort description remoteHost leaseTime
 0 TCP 34674-&amp;gt;192.168.2.2:34674 'NAT-PMP 29996' '' 0
 1 UDP 34674-&amp;gt;192.168.2.2:34674 'NAT-PMP 29996' '' 0
GetGenericPortMappingEntry() returned 713 (SpecifiedArrayIndexInvalid)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Okay, so our Belkin supports this, let us add SSH port on our Pi,&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pi@raspberrypi:~ $ upnpc -e 'SSH on Raspberry Pi' -r 22 TCP
upnpc : miniupnpc library test client. (c) 2005-2014 Thomas Bernard
Go to http://miniupnp.free.fr/ or http://miniupnp.tuxfamily.org/
for more information.
List of UPNP devices found on the network :
 desc: http://192.168.2.1:35108/rootDesc.xml
 st: urn:schemas-upnp-org:device:InternetGatewayDevice:1

Found valid IGD : http://192.168.2.1:35108/ctl/IPConn
Local LAN ip address : 192.168.2.12
ExternalIPAddress = 10.242.204.104
InternalIP:Port = 192.168.2.12:22
external 10.242.204.104:22 TCP is redirected to internal 192.168.2.12:22 (duration=0)

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ha, it gets added!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/SKnzvfm.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;But sadly, no luck even then,&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ ssh pi@10.242.204.104
ssh: connect to host 10.242.204.104 port 22: Connection refused
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Maybe lets call it a day and let those ISP folks to get back.&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;finally&quot;&gt;Finally..&lt;/h3&gt;
&lt;p&gt;Eventhough the outcome is not positive, this has been a wonderful learning experience. I have a Pi in my home which I can remote into whenever I feel like. And always looking to do more things with the Pi.&lt;/p&gt;

&lt;p&gt;When you start digging, you might go really deep. Be carful to bring your head above once in a while to see what you are doing.&lt;/p&gt;

&lt;p&gt;* You would need NAT for outgoing requests as well. Think about it, TCP is a duplex protocol. So a packet coming from outside needs to find its way to the ‘Private IP’. However, it is internally managed by the router.&lt;/p&gt;</content><author><name>Anoop Elias</name></author><summary type="html">I had a Raspberry Pi 3 lying around, and I had a great idea. Let’s host a Tor relay! This is the story of that failed mission. Do you copy?</summary></entry></feed>